name: CD (Build, Push to ACR, and Deploy to VM)

# develop ë¸Œëœì¹˜ì— pushê°€ ë°œìƒí–ˆì„ ë•Œ ì‹¤í–‰
on:
  push:
    branches: [ develop ]


jobs:
  # 1. Docker ì´ë¯¸ì§€ë¥¼ ë¹Œë“œí•˜ê³  ACRì— Pushí•˜ëŠ” ì¡
  build-and-push-to-acr:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Azure Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.ACR_LOGIN_SERVER }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      - name: Build and push Docker image
        # github.shaëŠ” ì»¤ë°‹ IDë¡œ, ì´ë¯¸ì§€ì— ê³ ìœ í•œ íƒœê·¸ë¥¼ ë¶€ì—¬í•©ë‹ˆë‹¤.
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ secrets.ACR_LOGIN_SERVER }}/ssg-tab:${{ github.sha }}

  # 2. ë¹Œë“œëœ ì´ë¯¸ì§€ë¥¼ VMì— ë°°í¬í•˜ëŠ” ì¡
  deploy-to-vm:
    runs-on: ubuntu-latest
    # build-and-push-to-acr ì¡ì´ ì„±ê³µí•´ì•¼ë§Œ ì‹¤í–‰
    needs: build-and-push-to-acr

    steps:
      - name: Deploy to Azure VM
        # SSHë¥¼ í†µí•´ ì›ê²©ìœ¼ë¡œ ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í•˜ëŠ” ì•¡ì…˜
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USERNAME }}
          key: ${{ secrets.VM_SSH_PRIVATE_KEY }}
          script: |
            # VMì—ì„œ ACRì— ë¡œê·¸ì¸
            docker login ${{ secrets.ACR_LOGIN_SERVER }} -u ${{ secrets.ACR_USERNAME }} -p ${{ secrets.ACR_PASSWORD }}
            
            # ë°©ê¸ˆ ë¹Œë“œí•œ ìƒˆë¡œìš´ ì´ë¯¸ì§€ë¥¼ Pull
            docker pull ${{ secrets.ACR_LOGIN_SERVER }}/ssg-tab:${{ github.sha }}
            
            # ê¸°ì¡´ì— ì‹¤í–‰ë˜ë˜ ì»¨í…Œì´ë„ˆê°€ ìˆë‹¤ë©´ ì¤‘ì§€í•˜ê³  ì‚­ì œ (ì—†ì–´ë„ ì˜¤ë¥˜ë‚˜ì§€ ì•ŠìŒ)
            docker stop ssg-tab-container || true
            docker rm ssg-tab-container || true
            
            # ìƒˆë¡œìš´ ì»¨í…Œì´ë„ˆë¥¼ ì‹¤í–‰ (DB, Redis ì ‘ì† ì •ë³´ë¥¼ í™˜ê²½ë³€ìˆ˜ë¡œ ì£¼ì…)
            # VMì˜ 80ë²ˆ í¬íŠ¸ë¥¼ ì»¨í…Œì´ë„ˆì˜ 8080 í¬íŠ¸ì™€ ì—°ê²°
            docker run -d --name ssg-tab-container -p 80:8080 \
              -e DB_HOST=${{ secrets.DB_HOST }} \
              -e DB_NAME=${{ secrets.DB_NAME }} \
              -e DB_USER=${{ secrets.DB_USER }} \ 
              -e DB_PASSWORD=${{ secrets.DB_PASSWORD }} \
              -e REDIS_HOST=${{ secrets.REDIS_HOST }} \
              -e REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }} \
              -e JWT_SECRET_KEY=${{ secrets.JWT_SECRET_KEY }} \
              -e AZURE_STORAGE_ACCOUNT_NAME=${{ secrets.AZURE_STORAGE_ACCOUNT_NAME }} \
              -e AZURE_STORAGE_ACCOUNT_KEY=${{ secrets.AZURE_STORAGE_ACCOUNT_KEY }} \
              -e AZURE_STORAGE_ENDPOINT=${{ secrets.AZURE_STORAGE_ENDPOINT }} \
              -e NAVER_CLIENT_ID=${{ secrets.NAVER_CLIENT_ID }} \
              -e NAVER_CLIENT_SECRET=${{ secrets.NAVER_CLIENT_SECRET }} \
              ${{ secrets.ACR_LOGIN_SERVER }}/ssg-tab:${{ github.sha }}

  send_discord_message:
    needs: deploy-to-vm
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Send Discord message
        uses: Ilshidur/action-discord@master
        with:
          args: "ë°°í¬ ê²°ê³¼ ì•Œë¦¼"
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          DISCORD_USERNAME: "ë°°í¬ë´‡ ğŸ¤–"
          DISCORD_EMBEDS: >
            [
              {
                "title": "ğŸš€ ë°°í¬ ê²°ê³¼",
                "color": ${{ needs.deploy-to-vm.result == 'success' && 3066993 || 15158332 }},
                "fields": [
                  {
                    "name": "ìƒíƒœ",
                    "value": "${{ needs.deploy-to-vm.result == 'success' && 'âœ… ì„±ê³µ' || 'âŒ ì‹¤íŒ¨' }}"
                  }
                ]
              }
            ]
            
